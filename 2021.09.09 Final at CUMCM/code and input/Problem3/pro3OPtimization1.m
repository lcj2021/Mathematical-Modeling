clear all; clc;
dev = devi();
load opti1Input

w = zeros(25, 1);
o_opti = zeros(11, 24); %% 附件A输出
s_opti = zeros(11, 24);
cost = [];              %% 成本
w(1) = 28200 * 2;

%% 对24周循环 做非线性规划
for i = 1 : 24
   A= [
    -1/0.72*0.99, -1/0.72*0.99, -1/0.66*0.99, ...
    -1/0.66*0.99, -1/0.66*0.99, -1/0.72*0.99, ... 
    -1/0.6*0.99, -1/0.6*0.99, -1/0.6*0.99, -1/0.72*0.99, -1/0.6*0.99;
    1,0,0,0,0,0,0,0,0,0,0;
    0,1,0,0,0,0,0,0,0,0,0;
    0,0,1,0,0,0,0,0,0,0,0;
    0,0,0,1,0,0,0,0,0,0,0;
    0,0,0,0,1,0,0,0,0,0,0;
    0,0,0,0,0,1,0,0,0,0,0;
    0,0,0,0,0,0,1,0,0,0,0;
    0,0,0,0,0,0,0,1,0,0,0;
    0,0,0,0,0,0,0,0,1,0,0;
    0,0,0,0,0,0,0,0,0,1,0;
    0,0,0,0,0,0,0,0,0,0,1;   
    1,1,0,0,0,1,0,0,0,1,0;
    0,0,0,0,0,0,-1,-1,-1,0,-1;
    ];

    b = [
    -(28200*2+cap(i)-w(i));
    2276.47 + dev(1,  i);
    967.87  + dev(2,  i);
    4870.80 + dev(3,  i);
    6000.00 + dev(4,  i);
    6000.00 + dev(5,  i);
    3909.27 + dev(6,  i);
    4811.13 + dev(7,  i);
    4929.13 + dev(8,  i);
    4897.73 + dev(9,  i);
    3108.20 + dev(10, i);
    3511.47 + dev(11, i);
    con1(i);
    -con2(i);
    ];
    
    %% 等式约束 预测得到的缺货空窗期 不能订货
    Aeq = [
    g(1, i),g(2, i),g(3, i),g(4, i),g(5, i),g(6, i),...
    g(7, i),g(8, i),g(9, i), g(10, i), g(11, i);
    0, 0, 1, 0, 0, 0, 0, 0, 0, 0 ,0;
    ];

    beq = [    
    0;0;
    ];

    lb = zeros(1, 11);
%     intcon = 1:8;
    option = optimoptions(@fmincon, 'TolX', 1e-4, 'TolFun', 1e-2 );
    [o,fval] = fmincon(@goal, rand(11, 1), A, b, Aeq, beq, lb, [], [], option); 
    
    o_opti(: , i) = o;
    cost = [cost, o(1)+o(2)+1.1*o(3)+1.1*o(4)+1.1*o(5)+o(6)+1.2*o(7)+1.2*o(8)+1.2*o(9)+o(10)+1.2*o(11)];
    
    for j = 1 : 11
        s_opti(j, i) = o(j) - dev(j,  i);
    end
    
    %% 更新库存
    w(i + 1) = w(i) - 28200 + 1/0.72* ( o(1) - dev(1,  i) )+ ...
1/0.72* ( o(2) - dev(2,  i) )+1/0.66* ( o(3) - dev(3,  i) )+...
1/0.66* ( o(4) - dev(4,  i) )+1/0.66* ( o(5) - dev(5,  i) )+...
1/0.72* ( o(6) - dev(6,  i) )+1/0.6 * ( o(7) - dev(7,  i) )+...
1/0.6 * ( o(8) - dev(8,  i) )+1/0.6 * ( o(9) - dev(9,  i) )+...
1/0.72* (o(10) - dev(10, i) )+1/0.6 * (o(11) - dev(11, i) );
    
end

o_opti([o_opti < 15]) = 0;
o_opti = ceil(o_opti);
s_opti([s_opti < 15]) = 0;
s_opti = ceil(s_opti);
save('opti1Output.mat','cost','o_opti','s_opti');
function [out] = devi()         %% 生成order - supply的随机误差
    out = zeros(11, 24);
    for i = 1 : 11
        for j = 1 : 24
            out(i, j) = -9 + 10 * rand(1); %% 随机误差范围[-9, 1]
        end
    end
end

function out = goal(o)
    load opti1Input
    global w;
    %% C少A多指标 indic1
    indic1 = 0;
    indic1 = indic1 + (o(1)+o(2)+o(6)+o(10)) / (o(7)+o(8)+o(9)+o(11));
    %% 成本指标 indic2
    indic2 = o(1)+o(2)+1.1*o(3)+1.1*o(4)+1.1*o(5)+o(6)+1.2*o(7)+1.2*o(8)+1.2*o(9)+o(10)+1.2*o(11);
    indic2 = indic2 / 21260.15745;
    %% 两者权重为0.25 : 0.75
    out = 0.2 * indic1 + 0.8 * indic2;
end